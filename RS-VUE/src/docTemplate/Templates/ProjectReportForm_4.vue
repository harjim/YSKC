<!-- @Description:项目立项报告_昆山模板 -->
<template>
  <a-card>
    <a-form>
      <div style="height:100px;"></div>
      <div style="height:900px;">
        <div style="text-align: center;">
          <h2 style="font-size: 36px;">企业技术开发项目设计书</h2>
        </div>
        <div style="height:200px;"></div>
        <table style="border-collapse: collapse; width: 100%;">
          <tbody>
            <tr>
              <td style="width: 14%;" ></td>
              <td
                style="width: 15%;  vertical-align:top; padding-top: 7px; font-size: 21px; text-align:justify; text-align-last:justify;"
                align="right">项目名称</td>
              <td style="width: 2%; font-size: 21px; vertical-align:top; padding-top: 7px; font-size: 21px;" >：</td>
              <td style="width: 55%; font-size: 21px; vertical-align:top; border-bottom: 1px solid; line-height: 36px;" colspan="4">{{ publicInfo.commonMap.pname }}</td>
              <td style="width: 14%;" ></td>
            </tr>
            <tr>
              <td style="width: 14%;"></td>
              <td style="width: 15%; font-size: 21px; text-align:justify; text-align-last:justify;" align="right">企业名称</td>
              <td style="width: 2%; font-size: 21px;" >：</td>
              <td style="width: 55%; font-size: 21px; border-bottom: 1px solid;" colspan="4">{{ publicInfo.commonMap.companyName }}</td>
              <td style="width: 14%;" ></td>
            </tr>
            <tr>
              <td style="width: 14%;"></td>
              <td style="width: 15%; font-size: 21px; text-align:justify; text-align-last:justify;" align="right">企业法人（签名）</td>
              <td style="width: 2%; font-size: 21px;" >：</td>
              <td style="width: 30%; font-size: 21px; border-bottom: 1px solid;" ></td>
              <td style="width: 6%; font-size: 21px; vertical-align:top; border-bottom: 1px solid; line-height: 36px;" ></td>
              <td style="width: 2%; font-size: 21px; vertical-align:top; border-bottom: 1px solid; line-height: 36px;" ></td>
              <td style="width: 17%; font-size: 21px; vertical-align:top; border-bottom: 1px solid; line-height: 36px;" ></td>
              <td style="width: 14%;" ></td>
            </tr>
            <tr>
              <td style="width: 14%;"></td>
              <td style="width: 15%; font-size: 21px; text-align:justify; text-align-last:justify;" align="right">项目负责人</td>
              <td style="width: 2%; font-size: 21px;" >：</td>
              <td style="width: 30%; font-size: 21px; border-bottom: 1px solid;" >{{ publicInfo.commonMap.projectMasterName }}</td>
              <td style="width: 6%; font-size: 21px; text-align:justify; text-align-last:justify;" align="right"><i class="required-field"/>电话</td>
              <td style="width: 2%; font-size: 21px;">：</td>
              <td style="width: 17%; font-size: 21px; vertical-align:top; border-bottom: 1px solid; line-height: 36px;" ><a-input v-model="content.mobile"/></td>
              <td style="width: 14%;" ></td>
            </tr>
            <tr>
              <td style="width: 14%;"></td>
              <td style="width: 15%; font-size: 21px;  text-align:justify; text-align-last:justify;" align="right">项目起止时间</td>
              <td style="width: 2%; font-size: 21px;" >：</td>
              <td style="width: 55%; font-size: 21px;  border-bottom: 1px solid;" colspan="4">{{ publicInfo.commonMap.beginAndEndMonth }}</td>
              <td style="width: 14%;" ></td>
            </tr>
            <tr>
              <td style="width: 14%;">&nbsp;</td>
              <td style="width: 15%;">&nbsp;</td>
              <td style="width: 2%;">&nbsp;</td>
              <td style="width: 30%;">&nbsp;</td>
              <td style="width: 6%;">&nbsp;</td>
              <td style="width: 2%;">&nbsp;</td>
              <td style="width: 17%;">&nbsp;</td>
              <td style="width: 14%;">&nbsp;</td>
            </tr>
          </tbody>
        </table>
        <div style="height: 50px"></div>
        <div style="text-align: center; font-size: 21px;"><i class="required-field"/>填报日期
          <a-date-picker
            :getCalendarContainer="getCalendarContainer"
            :value="content.fillDate ? moment(content.fillDate,'YYYY-MM-DD') : content.fillDate"
            format="YYYY-MM-DD"
            @change="onfillDateChange"
          />
        </div>
        <div style="height: 50px"></div>
        <div style="text-align: center; font-size: 21px;">江苏省科技厅2006年制</div>
      </div>
      <div>
        <h2>一、立项依据</h2>
        <h3><i class="required-field"/>1. 国内外现状、水平和发展趋势</h3>
        <wang-editor
          key="trend"
          v-model="content.trend"
          :projectId="project.id"
          placeholder="国内外现状、水平和发展趋势"
        />
        <h3><i class="required-field"/>2. 项目开发的目的、意义</h3>
        <wang-editor
          key="purpose"
          v-model="content.purpose"
          :projectId="project.id"
          placeholder="项目开发的目的、意义"
        />
        <h3><i class="required-field"/>3. 本项目达到的技术水平及市场前景</h3>
        <wang-editor
          key="prospects"
          v-model="content.prospects"
          :projectId="project.id"
          placeholder="本项目达到的技术水平及市场前景"
        />
      </div>
      <div>
        <h2>二、开发内容和目标</h2>
        <h3><i class="required-field"/>1. 项目主要内容、目标及关键技术</h3>
        <wang-editor
          key="primaryContent"
          v-model="content.primaryContent"
          :projectId="project.id"
          placeholder="项目主要内容、目标及关键技术"
        />
        <h3><i class="required-field"/>2．技术创新之处</h3>
        <wang-editor
          key="innovation"
          v-model="content.innovation"
          :projectId="project.id"
          placeholder="技术创新之处"
        />
        <h3><i class="required-field"/>3．主要技术指标或经济指标</h3>
        <wang-editor
          key="indicatorsOrBenefits"
          v-model="content.indicatorsOrBenefits"
          :projectId="project.id"
          placeholder="主要技术指标或经济指标"
        />
      </div>
      <div>
        <h2><i class="required-field"/>三、开发试验方法及技术路线（工艺路线）</h2>
        <wang-editor
          key="methodAndRoute"
          v-model="content.methodAndRoute"
          :projectId="project.id"
          placeholder="开发试验方法及技术路线（工艺路线）"
        />
      </div>
      <div>
        <h2>四、现有开发条件和工作基础</h2>
        <h3><i class="required-field"/>1. 承担单位开展本项目的优势（人才、设施条件）</h3>
        <wang-editor
          key="advantage"
          v-model="content.advantage"
          :projectId="project.id"
          placeholder="承担单位开展本项目的优势（人才、设施条件）"
        />
        <h3><i class="required-field"/>2．已有的工作基础，如预试及小试成果等</h3>
        <wang-editor
          key="workBasis"
          v-model="content.workBasis"
          :projectId="project.id"
          placeholder="已有的工作基础，如预试及小试成果等"
        />
      </div>
      <div>
        <h2><i class="required-field"/>五、计划进度（包括总的研究期限、年度计划进度）</h2>
        <div>
          <a-button type="primary" style="margin-bottom: 10px;margin-right:10px;" @click="addRow">添加</a-button>
          <a-button type="primary" style="margin-bottom: 10px;margin-right:10px;" @click="addStage">引入项目阶段</a-button>
          <vxe-grid
            ref="table"
            :data="content.stageList"
            border
            resizable
            auto-resize
            highlight-hover-row
            show-overflow
            show-header-overflow
            highlight-current-row
            header-align="center"
          >
            <vxe-table-column title="阶段" type="seq" width="55" align="center"></vxe-table-column>
            <vxe-table-column title="时间" field="beginDate" width="300" align="center" header-align="center">
              <template #default="{row}">
                <a-date-picker
                  style="width:120px;"
                  :getCalendarContainer="getCalendarContainer"
                  @change="(dates,dateString)=>onDateChange(dateString,row,'beginDate')"
                  :value="row.beginDate ? moment(row.beginDate,'YYYY-MM-DD') :row.beginDate"
                  format="YYYY-MM-DD"
                  :allowClear="false"
                  :disabledDate="(val)=>disabledBDate(val,row)"
                  @openChange="(status) => onOpenChange(status,'beginDate',row)"
                />
                -
                <a-date-picker
                  style="width:120px;"
                  :getCalendarContainer="getCalendarContainer"
                  @change="(dates,dateString)=>onDateChange(dateString,row,'endDate')"
                  :value="row.endDate ? moment(row.endDate,'YYYY-MM-DD') :row.endDate"
                  format="YYYY-MM-DD"
                  :allowClear="false"
                  :disabledDate="(val)=>disabledEDate(val,row)"
                  @openChange="(status) => onOpenChange(status,'endDate',row)"
                />
              </template>
            </vxe-table-column>
            <vxe-table-column title="完成内容" field="mainWork" min-width="300" align="left" header-align="center">
              <template #default="{row}">
                <a-textarea v-model="row.mainWork" placeholder="完成内容" :rows="2"></a-textarea>
              </template>
            </vxe-table-column>
            <vxe-table-column title="操作" width="90" align="center" header-align="center">
              <template #default="{row}">
                <a type="primary" @click="removeRow(row)">移除</a>
              </template>
            </vxe-table-column>
          </vxe-grid>
        </div>
      </div>

      <div>
        <h2>六、经费概算</h2>
        <div> 项目预计总经费{{ publicInfo.commonMap.totalBudget }}万元。</div>
        <div style="text-align: center;">项目经费支出预算表</div>
        <div style="text-align: right;">单位：万元</div>
        <vxe-grid
          ref="budgetTable"
          :data="content.tableDatas"
          size="small"
          border
          resizable
          auto-resize
          highlight-hover-row
          show-overflow
          show-header-overflow
          highlight-current-row
          show-footer
          :footer-method="footerMethod"
          :footer-span-method="footerColspanMethod"
        >
          <vxe-table-column title="经费支出预算" align="center" header-align="center" >
            <vxe-table-column title="科目" field="subjectName" align="left" header-align="center" min-width="200"></vxe-table-column>
            <vxe-table-column title="预算数" align="center" header-align="center" >
              <vxe-table-column
                v-for=" year in years"
                :key="year"
                :field="year+''"
                :title="`${year}年`"
                align="center"
                header-align="center" >
                <template #default="{row}">
                  <!-- <a-input-number v-if="![12,13].includes(row.key)" v-model="row[year]" placeholder="预算数" style="width: 100%;" @blur="computedTotal(year)"/> -->
                  <a-input-number v-if="![13].includes(row.key)" v-model="row[year]" placeholder="预算数" @blur="updateFooter" style="width: 100%;" />
                  <span v-else>{{ row[year] || 0 }}</span>
                </template>
              </vxe-table-column>
            </vxe-table-column>
          </vxe-table-column>
        </vxe-grid>
      </div>

      <div>
        <h2><i class="required-field"/>七、主要（大中型）仪器设备清单</h2>
        <chapter-8-tab
          ref="chapter8Tab"
          :content="content"
          :project="project"
          :docId="docId"
        />
      </div>

      <div>
        <h2><i class="required-field"/>八、技术研究开发机构名称及情况</h2>
        <wang-editor
          key="devInstitution"
          v-model="content.devInstitution"
          :projectId="project.id"
          placeholder="技术研究开发机构名称及情况"
        />
      </div>

      <div>
        <h2><i class="required-field"/>九、主要研究人员情况</h2>
        <chapter-7-tab
          ref="chapter7Tab"
          :content="content"
          :project="project"
          :docId="docId"
          :columns="memberColumns"
        />
      </div>

      <div style="height: 100px;"></div>

      <table style="width: 100%">
        <tr>
          <td style="width: 50%"></td>
          <td>企业盖章</td>
        </tr>
        <tr>
          <td></td>
          <td>年&nbsp;&nbsp;&nbsp;&nbsp;月&nbsp;&nbsp;&nbsp;&nbsp;日</td>
        </tr>
      </table>
    </a-form>
  </a-card>
</template>
<script>
import moment from 'moment'
import yearMiXin from '@/utils/yearMixin'
import { getTemplateContent } from '@/docTemplate/Templates/js/templateContentType'
import dateMixin from './js/dateMixin'
import WangEditor from '@/components/Editor/WangEditor'
import Chapter5Tab from './projectReportTab/Chapter5Tab'
import Chapter7Tab from './projectReportTab/Chapter7Tab'
import Chapter8Tab from './projectReportTab/Chapter8Tab'
import { popupContainer, domName } from '@/docTemplate/Templates/js/screenFullMountDom'
import { mapGetters } from 'vuex'

export default {
  name: 'ProjectReportForm',
  mixins: [yearMiXin, dateMixin],
  components: { WangEditor, Chapter5Tab, Chapter7Tab, Chapter8Tab },

  created () {
    this.content = getTemplateContent('projectReportForm_4')
    this.BPContent = getTemplateContent('projectReportForm_4')
  },
  props: {
    projectId: {
      type: Number,
      required: true
    },
    docId: {
      type: Number,
      required: true
    },
    project: {
      type: Object,
      required: true
    }
  },
  data () {
    return {
      domName,
      labelCol: {
        xs: { span: 24 },
        sm: { span: 6 }
      },
      wrapperCol: {
        xs: { span: 24 },
        sm: { span: 14 }
      },
      content: {},
      BPContent: {},
      currentYear: 2020,
      row: { beginDate: undefined, endDate: undefined, mainWork: '' },
      memberColumns: [
        { title: '姓名', field: 'ename' },
        { title: '单位', field: 'companyName' },
        { title: '性别', field: 'gender' },
        { title: '年龄', field: 'age' },
        { title: '专业', field: 'specialities' },
        { title: '职务(职称)', field: 'position' },
        { title: '本项目中承担工作', field: 'role' }
      ],
      requiredFields: ['mobile', 'fillDate', 'trend', 'purpose', 'prospects', 'primaryContent', 'innovation', 'indicatorsOrBenefits', 'methodAndRoute', 'advantage', 'workBasis', 'stageList', 'devInstitution']
    }
  },
  mounted () {
    // this.loadDept()
  },
  watch: {
    project (v) {
      this.content._pro = v.id
      this.content._emp = v.masterENumber
    }
  },
  computed: {
    years () {
      const result = []
      const { beginYear, endYear } = this.project
      for (let i = beginYear; i <= endYear; i++) {
        result.push(i)
      }
      return result
    },
    ...mapGetters(['userInfo'])
  },
  methods: {
    search () {
      this.currentYear = this.currentYear
    },
    updateFooter () {
      this.$refs.budgetTable.updateFooter()
    },
    footerMethod ({ columns, data }) {
      const combined = []
      const total = []
      columns.map((column, index) => {
        if (index === 0) {
          combined.push('合计')
          total.push('总计')
        }
        if (index >= 1) {
          combined.push(this.sumNum(data, column.property))
        }
      })
      columns.map((column, index) => {
        if (index === 1) {
          total.push(this.totalNum())
        }
      })
      return [combined, total]
    },
    sumNum (list, field) {
      const yearTotal = this.content.tableDatas.reduce((total, currentValue) => {
        if (currentValue[field]) {
          return total + Number(currentValue[field])
        } else {
          return total
        }
      }, 0)
      this.$set(this.content.sumBudget, field, yearTotal)
      return yearTotal
    },
    totalNum () {
      let count = 0
      this.years.forEach((year, index) => {
        count += Number(this.content.sumBudget[year]) || 0
      })
      this.content.totalBuget = count
      return count
    },
    footerColspanMethod ({ $rowIndex, _columnIndex }) {
      if ($rowIndex === 1) {
        if (_columnIndex < 1) {
          return {
            rowspan: 1,
            colspan: 1
          }
        }
        if (_columnIndex === 1) {
          return {
            rowspan: 1,
            colspan: this.years.length
          }
        } else {
          return {
            rowspan: 0,
            colspan: 0
          }
        }
      }
    },
    getCalendarContainer (trigger) {
      return popupContainer(this.domName)
    },
    disabledBDate (current, record) {
      if (record.endDate !== undefined) {
        return moment(this.project.beginDate) > current || current >= moment(record.endDate).add(1, 'days')
      }
      return moment(this.project.beginDate) > current || current >= moment(this.project.endDate).add(1, 'days')
    },
    disabledEDate (current, record) {
      if (record.beginDate !== undefined) {
        return current >= moment(this.project.endDate).add(1, 'days') || current < moment(record.beginDate)
      }
      return moment(this.project.beginDate) > current || current >= moment(this.project.endDate).add(1, 'days')
    },
    callback (activeKey) {
      // 切换tab调用
      this.activeKey = activeKey
    },
    onDateChange (dateString, record, name) { this.$set(record, name, dateString) },
    onfillDateChange (dateString, record) {
      this.content.fillDate = record
    },
    addRow () {
      const tempRow = { ...this.row }
      tempRow.num = this.content.stageList.length + 1
      this.content.stageList.push(tempRow)
    },
    addStage () {
      this.$http.get('/projectDocFile/getReportStage', { params: { projectId: this.project.id } })
        .then(res => {
          if (res.data) {
            this.tableDate = res.data
            let num = this.content.stageList.length
            this.content.stageList.push(...res.data.map(item => {
              return {
                num: ++num,
                beginDate: item.beginDate,
                endDate: item.endDate,
                mainWork: (item.stageType ? item.stageType + ':' : '') + (item.workDesc ? item.workDesc : '')
              }
            }))
          }
        })
    },
    removeRow (record) {
      const tempRows = []
      var num = 0
      for (var i = 0; i < this.content.stageList.length; i++) {
        const row = this.content.stageList[i]
        if (row.num !== record.num) {
          row.num = ++num
          tempRows.push(row)
        }
      }
      this.content.stageList = tempRows
    },
    onOpenChange (status, field, record) {
      if (!record[field] && status) {
        record[field] = moment(this.project.beginDate).format('YYYY-MM-DD')
      }
    }
  }
}
</script>

<style lang="less" scoped>
h1,h2,h3,h4,h5 {
font-weight: 650;
}
.footer {
  display: flex;
  margin: 24px 0 ;
  .item {
    display: flex;
    flex: 1;
    align-items:center;
    .input {
      flex: 1;
      margin: 0 8px;
    }
  }
}
</style>
